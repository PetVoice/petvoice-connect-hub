name: Build Android AAB - FINALE PULITO
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Build web app
        run: npm run build
        
      - name: Initialize Capacitor if needed
        run: |
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.js" ]; then
            echo "üöÄ Initializing Capacitor..."
            npx cap init "PetVoice" "com.petvoice.connect.v5" --web-dir="dist"
            echo "‚úÖ Capacitor initialized"
          fi
          
      - name: Show Capacitor config
        run: |
          echo "=== CAPACITOR CONFIG ==="
          if [ -f "capacitor.config.ts" ]; then
            cat capacitor.config.ts
          elif [ -f "capacitor.config.js" ]; then
            cat capacitor.config.js
          fi
          
      - name: Add Android platform
        run: |
          if [ ! -d "android" ]; then
            echo "Adding Android platform..."
            npx cap add android
          fi
          
      - name: Sync Capacitor
        run: npx cap sync android
        
      - name: Generate FIXED keystore with consistent SHA1
        run: |
          cd android/app
          mkdir -p keystore
          
          # Crea keystore con parametri identici ogni volta
          keytool -genkeypair -v \
            -keystore keystore/release.keystore \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias petvoice \
            -storepass petvoice123 \
            -keypass petvoice123 \
            -dname "CN=PetVoice Connect, OU=Development, O=PetVoice Inc, L=Rome, S=Lazio, C=IT" \
            -storetype JKS
            
          echo "‚úÖ Fixed keystore generated"
          
          # Mostra SHA1 - dovrebbe essere sempre uguale
          echo "=== SHA1 FINGERPRINT ==="
          keytool -list -v -keystore keystore/release.keystore -storepass petvoice123 | grep SHA1 | head -1
          
          # Backup keystore per debug
          base64 keystore/release.keystore > keystore/release.keystore.base64
          echo "Keystore base64 per debug:"
          head -c 100 keystore/release.keystore.base64
          
      - name: Configure signing
        run: |
          cd android/app
          cat > keystore.properties << EOF
          storePassword=petvoice123
          keyPassword=petvoice123
          keyAlias=petvoice
          storeFile=keystore/release.keystore
          EOF
          
      - name: Update build.gradle for signing
        run: |
          cd android/app
          # Backup originale
          cp build.gradle build.gradle.bak
          
          # Aggiungi configurazione signing
          cat > build.gradle << 'EOF'
          apply plugin: 'com.android.application'

          def keystorePropertiesFile = rootProject.file("app/keystore.properties")
          def keystoreProperties = new Properties()
          keystoreProperties.load(new FileInputStream(keystorePropertiesFile))

          android {
              namespace "com.petvoice.connect.v5"
              compileSdk rootProject.ext.compileSdkVersion
              defaultConfig {
                  applicationId "com.petvoice.connect.v5"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 7
                  versionName "1.0.6"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
                  aaptOptions {
                       // Files and dirs to omit from the packaged APK/AAB
                       // Dir -> dirs to omit
                       // File -> files to omit
                       ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
                  }
              }
              signingConfigs {
                  release {
                      keyAlias keystoreProperties['keyAlias']
                      keyPassword keystoreProperties['keyPassword']
                      storeFile file(keystoreProperties['storeFile'])
                      storePassword keystoreProperties['storePassword']
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                  }
              }
          }

          repositories {
              google()
              mavenCentral()
          }

          dependencies {
              implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
              implementation "androidx.coordinatorlayout:coordinatorlayout:$androidxCoordinatorLayoutVersion"
              implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"
              implementation project(':capacitor-android')
              testImplementation "junit:junit:$junitVersion"
              androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
              androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
              implementation project(':capacitor-cordova-android-plugins')
          }

          apply from: 'capacitor.build.gradle'

          try {
              def servicesJSON = file('google-services.json')
              if (servicesJSON.text) {
                  apply plugin: 'com.google.gms.google-services'
              }
          } catch(Exception e) {
              logger.info("google-services.json not found, google-services plugin not applied. Push Notifications won't work")
          }
          EOF
          
      - name: Make gradlew executable
        run: chmod +x android/gradlew
        
      - name: Clean and build AAB
        run: |
          cd android
          echo "=== CLEANING ==="
          ./gradlew clean
          echo "=== BUILDING RELEASE AAB ==="
          ./gradlew bundleRelease --stacktrace --info
          
      - name: Verify AAB details
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          echo "=== AAB SIGNING VERIFICATION ==="
          echo "AAB file: $AAB_PATH"
          
          # Estrai e mostra info certificato dall'AAB
          if command -v jarsigner &> /dev/null; then
            echo "=== CERTIFICATO SHA1 DALL'AAB ==="
            jarsigner -verify -verbose -certs "$AAB_PATH" | grep SHA1 || echo "SHA1 non trovato"
          fi
          
          # Mostra SHA1 dal keystore
          echo "=== CERTIFICATO SHA1 DAL KEYSTORE ==="
          keytool -list -v -keystore android/app/keystore/release.keystore -storepass petvoice123 | grep SHA1
          
          # Verifica che AAB sia firmato
          echo "=== VERIFICA FIRMA AAB ==="
          jarsigner -verify "$AAB_PATH" && echo "‚úÖ AAB correttamente firmato" || echo "‚ùå AAB non firmato correttamente"  
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            echo "‚úÖ AAB created successfully"
            echo "File size: $(du -h $AAB_PATH | cut -f1)"
            echo "File type: $(file $AAB_PATH)"
            
            # Verifica contenuto AAB
            echo "=== AAB CONTENTS ==="
            unzip -l "$AAB_PATH" | head -20
            
            # Verifica AndroidManifest
            echo "=== CHECKING MANIFEST ==="
            aapt dump badging "$AAB_PATH" | head -10 || echo "aapt not available"
          else
            echo "‚ùå AAB not found at $AAB_PATH"
            find android -name "*.aab" -type f || echo "No AAB files found"
            exit 1
          fi
          
      - name: Show AAB signing info
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          echo "=== AAB SIGNING VERIFICATION ==="
          echo "AAB file: $AAB_PATH"
          
          # Estrai e mostra info certificato dall'AAB
          if command -v jarsigner &> /dev/null; then
            echo "=== CERTIFICATO SHA1 DALL'AAB ==="
            jarsigner -verify -verbose -certs "$AAB_PATH" | grep SHA1 || echo "SHA1 non trovato con jarsigner"
          fi
          
          # Mostra SHA1 dal keystore
          echo "=== CERTIFICATO SHA1 DAL KEYSTORE ==="
          keytool -list -v -keystore android/app/keystore/release.keystore -storepass petvoice123 | grep SHA1
          
          # Verifica che AAB sia firmato
          echo "=== VERIFICA FIRMA AAB ==="
          jarsigner -verify "$AAB_PATH" && echo "‚úÖ AAB correttamente firmato" || echo "‚ùå AAB non firmato correttamente"
          
      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: petvoice-signed-aab-v7
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30
