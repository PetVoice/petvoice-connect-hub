name: Build Android AAB - YAML CLEAN
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Build web app
        run: npm run build
        
      - name: Initialize Capacitor if needed
        run: |
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.js" ]; then
            echo "ðŸš€ Initializing Capacitor..."
            npx cap init "PetVoice" "com.petvoice.connect.v6" --web-dir="dist"
            echo "âœ… Capacitor initialized"
          fi
          
      - name: Force recreate Android platform
        run: |
          echo "ðŸš€ Force recreating Android platform completely"
          
          # Rimuovi android directory se esiste
          if [ -d "android" ]; then
            echo "Removing existing android directory"
            rm -rf android
          fi
          
          # Ricrea Android platform
          echo "Adding Android platform fresh"
          npx cap add android
          
          # Sync Capacitor
          echo "Syncing Capacitor"
          npx cap sync android
          
          # Verifica che sia stato creato tutto
          echo "=== ANDROID PLATFORM VERIFICATION ==="
          if [ -d "android" ]; then
            echo "âœ… android/ directory exists"
            
            if [ -f "android/gradlew" ]; then
              echo "âœ… gradlew exists"
              chmod +x android/gradlew
            else
              echo "âŒ gradlew missing - using gradle directly"
            fi
            
            if [ -f "android/app/build.gradle" ]; then
              echo "âœ… build.gradle exists"
            else
              echo "âŒ build.gradle missing - will create"
            fi
            
            echo "Android directory contents:"
            ls -la android/
          else
            echo "âŒ Android platform creation failed"
            exit 1
          fi
          
      - name: Setup persistent keystore
        run: |
          cd android/app
          mkdir -p keystore
          
          if [ -f "keystore/release.keystore" ]; then
            echo "âœ… Using existing keystore from repository"
          else
            echo "ðŸš€ Generating new keystore (first time only)"
            keytool -genkeypair -v \
              -keystore keystore/release.keystore \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -alias petvoice \
              -storepass petvoice123 \
              -keypass petvoice123 \
              -dname "CN=PetVoice Connect, OU=Development, O=PetVoice Inc, L=Rome, S=Lazio, C=IT" \
              -storetype JKS
            echo "âœ… New keystore generated"
          fi
          
      - name: Setup signing properties
        run: |
          cd android/app
          if [ ! -f "keystore.properties" ]; then
            cat > keystore.properties << 'EOF'
          storePassword=petvoice123
          keyPassword=petvoice123
          keyAlias=petvoice
          storeFile=keystore/release.keystore
          EOF
            echo "âœ… keystore.properties created"
          fi
          
      - name: Create build.gradle with signing
        run: |
          cd android/app
          echo "ðŸš€ Creating/updating build.gradle with signing config"
          
          # Backup existing if present
          if [ -f "build.gradle" ]; then
            cp build.gradle build.gradle.bak
            echo "âœ… Existing build.gradle backed up"
          fi
          
          # Create new build.gradle with signing config
          cat > build.gradle << 'BUILDEOF'
          apply plugin: 'com.android.application'

          def keystorePropertiesFile = rootProject.file("app/keystore.properties")
          def keystoreProperties = new Properties()
          keystoreProperties.load(new FileInputStream(keystorePropertiesFile))

          android {
              namespace "com.petvoice.connect.v6"
              compileSdk rootProject.ext.compileSdkVersion
              defaultConfig {
                  applicationId "com.petvoice.connect.v6"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 9
                  versionName "1.0.8"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
              }
              signingConfigs {
                  release {
                      keyAlias keystoreProperties['keyAlias']
                      keyPassword keystoreProperties['keyPassword']
                      storeFile file(keystoreProperties['storeFile'])
                      storePassword keystoreProperties['storePassword']
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                      debuggable false
                  }
              }
          }

          repositories {
              google()
              mavenCentral()
          }

          dependencies {
              implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
              implementation "androidx.coordinatorlayout:coordinatorlayout:$androidxCoordinatorLayoutVersion"
              implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"  
              implementation project(':capacitor-android')
              testImplementation "junit:junit:$junitVersion"
              androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
              androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
              implementation project(':capacitor-cordova-android-plugins')
          }

          apply from: 'capacitor.build.gradle'
          BUILDEOF
          echo "âœ… build.gradle updated with signing config"
          
      - name: Create proguard rules
        run: |
          cd android/app
          cat > proguard-rules.pro << 'PROEOF'
          # Capacitor rules
          -keep class com.getcapacitor.** { *; }
          -keep class com.capacitorjs.** { *; }
          -keep class com.petvoice.** { *; }
          -keepattributes *Annotation*
          -keepattributes SourceFile,LineNumberTable
          PROEOF
          echo "âœ… proguard-rules.pro created"
          
      - name: Setup Gradle Wrapper
        run: |
          cd android
          
          if [ ! -f "gradlew" ]; then
            echo "ðŸš€ Creating missing Gradle Wrapper"
            
            # Crea gradlew
            cat > gradlew << 'GRADLEWEOF'
          #!/bin/sh

          DEFAULT_JVM_OPTS='"-Dorg.gradle.appname=gradlew"'
          APP_NAME="Gradle"
          APP_BASE_NAME=$(basename "$0")

          # Resolve links: $0 may be a link
          PRG="$0"
          # Need this for relative symlinks.
          while [ -h "$PRG" ] ; do
              ls=$(ls -ld "$PRG")
              link=$(expr "$ls" : '.*-> \(.*\)
        
      - name: Clean and build AAB
        run: |
          cd android
          echo "=== CLEANING ==="
          ./gradlew clean
          echo "=== BUILDING RELEASE AAB ==="
          ./gradlew bundleRelease --stacktrace
          
      - name: Verify AAB created
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            echo "âœ… AAB created successfully"
            echo "File size: $(du -h $AAB_PATH | cut -f1)"
            ls -la "$AAB_PATH"
          else
            echo "âŒ AAB not found"
            find android -name "*.aab" -type f
            exit 1
          fi
          
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: petvoice-clean-aab-v9
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30)
              if expr "$link" : '/.*' > /dev/null; then
                  PRG="$link"
              else
                  PRG=$(dirname "$PRG")"/$link"
              fi
          done
          SAVED="$(pwd)"
          cd "$(dirname \"$PRG\")" >/dev/null
          APP_HOME="$(pwd -P)"
          cd "$SAVED" >/dev/null

          APP_ARGS=$(save "$@")
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

          # Determine the Java command to use to start the JVM.
          if [ -n "$JAVA_HOME" ] ; then
              if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                  JAVACMD="$JAVA_HOME/jre/sh/java"
              else
                  JAVACMD="$JAVA_HOME/bin/java"
              fi
              if [ ! -x "$JAVACMD" ] ; then
                  die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME"
              fi
          else
              JAVACMD="java"
              which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH."
          fi

          exec "$JAVACMD" $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"
          GRADLEWEOF
            
            # Crea gradle wrapper properties
            mkdir -p gradle/wrapper
            cat > gradle/wrapper/gradle-wrapper.properties << 'PROPEOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.11.1-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          PROPEOF
            
            # Scarica gradle wrapper jar
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.11.1/gradle/wrapper/gradle-wrapper.jar
            
            echo "âœ… Gradle Wrapper created"
          fi
          
          # Rendi eseguibile
          chmod +x gradlew
          
          # Verifica
          if [ -x "gradlew" ]; then
            echo "âœ… gradlew is executable"
            echo "Gradle version check:"
            ./gradlew --version || echo "Gradle check failed but continuing..."
          else
            echo "âŒ gradlew still not executable"
            exit 1
          fi
        
      - name: Clean and build AAB
        run: |
          cd android
          echo "=== CLEANING ==="
          ./gradlew clean
          echo "=== BUILDING RELEASE AAB ==="
          ./gradlew bundleRelease --stacktrace
          
      - name: Verify AAB created
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            echo "âœ… AAB created successfully"
            echo "File size: $(du -h $AAB_PATH | cut -f1)"
            ls -la "$AAB_PATH"
          else
            echo "âŒ AAB not found"
            find android -name "*.aab" -type f
            exit 1
          fi
          
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: petvoice-clean-aab-v9
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30
